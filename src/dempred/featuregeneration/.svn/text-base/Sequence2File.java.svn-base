package dempred.featuregeneration;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.util.Arrays;
import java.util.LinkedHashMap;

public class Sequence2File {
	private LinkedHashMap<Character, double[]> aamap;
	private int alphabetSize;
	private String[] featureNames;

	public Sequence2File(String filepath) throws IOException {
		alphabetSize = 0;
		readFeaturesFromFile(filepath);
	}

	public void readFeaturesFromFile(String filepath) throws IOException {
		aamap = new LinkedHashMap<Character, double[]>(25);
		BufferedReader bufReader = new BufferedReader(new FileReader(filepath));
		String line;
		int i = 0;
		while ((line = bufReader.readLine()) != null) {
			if (!line.startsWith("#")) {
				if (line.length() > 0 && i++ > 0)
					fillMap(line);
				else
					readHeader(line);
			}
		}
		bufReader.close();
	}

	private void fillMap(String line) throws IllegalArgumentException {
		String[] splittet = line.split(" ++");
		int numFeatures = splittet.length - 1;
		if (alphabetSize != numFeatures)
			throw new IllegalArgumentException(String.format("The number of features is not the same for all aminoacids in the feature file! alphabetSize:%d numFeatures:%d", alphabetSize, numFeatures));
		double[] features = new double[numFeatures];
		for (int i = 0; i < numFeatures; ++i)
			features[i] = Double.parseDouble(splittet[i + 1]);
		aamap.put(splittet[0].trim().toUpperCase().charAt(0), features);
	}

	private void readHeader(String line) throws IllegalArgumentException {
		String[] splittet = line.trim().split(" ++");
		int numFeatures = splittet.length;
		if (alphabetSize <= 0)
			alphabetSize = numFeatures;
		featureNames = new String[numFeatures];
		for (int i = 0; i < numFeatures; ++i)
			featureNames[i] = splittet[i];
	}

	public double[] generateFeature(String sequence) {
		sequence = sequence.toUpperCase();
		int seqLength = sequence.length();
		double[] featureVector = new double[alphabetSize * seqLength];
		double[] featureVectorTemp;
		try {
			for (int i = 0; i < seqLength; ++i) {
				featureVectorTemp = aamap.get(sequence.charAt(i));
				if (featureVectorTemp == null)
					throw new IllegalArgumentException("The inpufile contains aminoacids, that are not specified in the featurefile: " + sequence.charAt(i));
				for (int j = 0; j < alphabetSize; ++j)
					featureVector[i * alphabetSize + j] = featureVectorTemp[j];
			}
		} catch (IndexOutOfBoundsException e) {
			System.out.println(e);
		}
		return featureVector;
	}

	public int numFeatures() {
		return alphabetSize;
	}

	public String toString() {
		String lineSeperator = System.getProperty("line.separator");
		StringBuffer strBuffer = new StringBuffer();
		for (char key : aamap.keySet())
			strBuffer.append(key + " --> " + Arrays.toString(aamap.get(key)) + lineSeperator);
		return strBuffer.toString();
	}

	public String[] getFeatureNames() {
		return featureNames;
	}
}
